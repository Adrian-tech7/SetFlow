generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  BUSINESS
  CALLER
  ADMIN
}

enum Tier {
  BASIC
  ADVANCED
  ELITE
}

enum LeadStatus {
  AVAILABLE
  ASSIGNED
  IN_PROGRESS
  APPOINTMENT_SET
  COMPLETED
  RETURNED
}

enum AppointmentStatus {
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
  COMPLETED
  NO_SHOW
  DISPUTED
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED_BUSINESS
  RESOLVED_CALLER
  CLOSED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  passwordHash   String    @map("password_hash")
  role           UserRole
  emailVerified  DateTime? @map("email_verified")
  image          String?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  business       Business?
  caller         Caller?
  sessions       Session[]
  accounts       Account[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Business {
  id                  String   @id @default(cuid())
  userId              String   @unique @map("user_id")
  companyName         String   @map("company_name")
  industry            String?
  bookingLink         String?  @map("booking_link")
  stripeAccountId     String?  @map("stripe_account_id")
  stripeOnboarded     Boolean  @default(false) @map("stripe_onboarded")
  tier                Tier     @default(BASIC)
  totalLeadsUploaded  Int      @default(0) @map("total_leads_uploaded")
  totalAppointments   Int      @default(0) @map("total_appointments")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  leads           Lead[]
  leadAssignments LeadAssignment[]
  appointments    Appointment[]
  payments        Payment[]
  ratingsGiven    Rating[]         @relation("BusinessRatings")
  disputes        Dispute[]

  @@map("businesses")
}

model Caller {
  id                    String   @id @default(cuid())
  userId                String   @unique @map("user_id")
  displayName           String   @map("display_name")
  bio                   String?  @db.Text
  experienceYears       Int?     @map("experience_years")
  specialties           String[] @default([])
  stripeAccountId       String?  @map("stripe_account_id")
  stripeOnboarded       Boolean  @default(false) @map("stripe_onboarded")
  totalAppointmentsSet  Int      @default(0) @map("total_appointments_set")
  averageRating         Float?   @map("average_rating")
  profileApproved       Boolean  @default(false) @map("profile_approved")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  leadAssignments LeadAssignment[]
  appointments    Appointment[]
  payments        Payment[]
  ratingsReceived Rating[]         @relation("CallerRatings")

  @@map("callers")
}

model Lead {
  id           String     @id @default(cuid())
  businessId   String     @map("business_id")
  firstName    String     @map("first_name")
  lastName     String     @map("last_name")
  email        String?
  phone        String?
  company      String?
  title        String?
  notes        String?    @db.Text
  status       LeadStatus @default(AVAILABLE)
  uploadBatch  String?    @map("upload_batch")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  business    Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  assignments LeadAssignment[]
  appointment Appointment?

  @@map("leads")
}

model LeadAssignment {
  id          String   @id @default(cuid())
  leadId      String   @map("lead_id")
  callerId    String   @map("caller_id")
  businessId  String   @map("business_id")
  assignedAt  DateTime @default(now()) @map("assigned_at")
  returnedAt  DateTime? @map("returned_at")
  isActive    Boolean  @default(true) @map("is_active")

  lead     Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  caller   Caller   @relation(fields: [callerId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([leadId, callerId])
  @@map("lead_assignments")
}

model Appointment {
  id              String            @id @default(cuid())
  leadId          String            @unique @map("lead_id")
  callerId        String            @map("caller_id")
  businessId      String            @map("business_id")
  scheduledAt     DateTime          @map("scheduled_at")
  status          AppointmentStatus @default(PENDING_VERIFICATION)
  webhookData     Json?             @map("webhook_data")
  verifiedAt      DateTime?         @map("verified_at")
  notes           String?           @db.Text
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  lead     Lead     @relation(fields: [leadId], references: [id])
  caller   Caller   @relation(fields: [callerId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
  payment  Payment?
  dispute  Dispute?

  @@map("appointments")
}

model Payment {
  id                   String        @id @default(cuid())
  appointmentId        String        @unique @map("appointment_id")
  businessId           String        @map("business_id")
  callerId             String        @map("caller_id")
  tier                 Tier
  businessCharge       Int           @map("business_charge")
  callerPayout         Int           @map("caller_payout")
  platformFee          Int           @default(2500) @map("platform_fee")
  stripePaymentIntent  String?       @map("stripe_payment_intent")
  stripeTransferId     String?       @map("stripe_transfer_id")
  status               PaymentStatus @default(PENDING)
  processedAt          DateTime?     @map("processed_at")
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")

  appointment Appointment @relation(fields: [appointmentId], references: [id])
  business    Business    @relation(fields: [businessId], references: [id])
  caller      Caller      @relation(fields: [callerId], references: [id])

  @@map("payments")
}

model Rating {
  id          String   @id @default(cuid())
  businessId  String   @map("business_id")
  callerId    String   @map("caller_id")
  score       Int
  review      String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  business Business @relation("BusinessRatings", fields: [businessId], references: [id])
  caller   Caller   @relation("CallerRatings", fields: [callerId], references: [id])

  @@unique([businessId, callerId])
  @@map("ratings")
}

model Dispute {
  id             String        @id @default(cuid())
  appointmentId  String        @unique @map("appointment_id")
  businessId     String        @map("business_id")
  reason         String        @db.Text
  status         DisputeStatus @default(OPEN)
  resolution     String?       @db.Text
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  appointment Appointment @relation(fields: [appointmentId], references: [id])
  business    Business    @relation(fields: [businessId], references: [id])

  @@map("disputes")
}
