// SetFlow Database Schema
// B2B Appointment Booking Marketplace

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  BUSINESS
  CALLER
  ADMIN
}

enum Tier {
  BASIC
  ADVANCED
  ELITE
}

enum LeadStatus {
  AVAILABLE
  ASSIGNED
  IN_PROGRESS
  APPOINTMENT_SET
  EXPIRED
  RETURNED
}

enum AppointmentStatus {
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
  COMPLETED
  NO_SHOW
  DISPUTED
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED_BUSINESS
  RESOLVED_CALLER
  CLOSED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String    @map("password_hash")
  name           String
  role           UserRole
  avatarUrl      String?   @map("avatar_url")
  emailVerified  Boolean   @default(false) @map("email_verified")
  isActive       Boolean   @default(true) @map("is_active")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  business       Business?
  caller         Caller?

  @@map("users")
}

model Business {
  id                  String   @id @default(cuid())
  userId              String   @unique @map("user_id")
  companyName         String   @map("company_name")
  industry            String?
  website             String?
  phone               String?
  description         String?
  bookingLink         String?  @map("booking_link")
  stripeAccountId     String?  @map("stripe_account_id")
  stripeOnboarded     Boolean  @default(false) @map("stripe_onboarded")
  tier                Tier     @default(BASIC)
  totalLeadsUploaded  Int      @default(0) @map("total_leads_uploaded")
  totalAppointments   Int      @default(0) @map("total_appointments")
  avgRating           Float    @default(0) @map("avg_rating")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  leads               Lead[]
  leadAssignments     LeadAssignment[]
  appointments        Appointment[]
  payments            Payment[]
  ratingsGiven        Rating[] @relation("BusinessRatings")
  disputesCreated     Dispute[]

  @@map("businesses")
}

model Caller {
  id                    String   @id @default(cuid())
  userId                String   @unique @map("user_id")
  displayName           String   @map("display_name")
  bio                   String?
  phone                 String?
  specialties           String[] @default([])
  experienceYears       Int      @default(0) @map("experience_years")
  stripeAccountId       String?  @map("stripe_account_id")
  stripeOnboarded       Boolean  @default(false) @map("stripe_onboarded")
  tier                  Tier     @default(BASIC)
  totalAppointmentsSet  Int      @default(0) @map("total_appointments_set")
  successRate           Float    @default(0) @map("success_rate")
  avgRating             Float    @default(0) @map("avg_rating")
  isVerified            Boolean  @default(false) @map("is_verified")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  leadAssignments       LeadAssignment[]
  appointments          Appointment[]
  payments              Payment[]
  ratingsReceived       Rating[] @relation("CallerRatings")

  @@map("callers")
}

model Lead {
  id           String     @id @default(cuid())
  businessId   String     @map("business_id")
  firstName    String     @map("first_name")
  lastName     String     @map("last_name")
  email        String?
  phone        String?
  company      String?
  title        String?
  source       String?
  notes        String?
  status       LeadStatus @default(AVAILABLE)
  batchId      String?    @map("batch_id")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  business     Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  assignments  LeadAssignment[]

  @@index([businessId, status])
  @@index([batchId])
  @@map("leads")
}

model LeadAssignment {
  id           String   @id @default(cuid())
  leadId       String   @map("lead_id")
  callerId     String   @map("caller_id")
  businessId   String   @map("business_id")
  assignedAt   DateTime @default(now()) @map("assigned_at")
  expiresAt    DateTime @map("expires_at")
  isActive     Boolean  @default(true) @map("is_active")

  lead         Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  caller       Caller   @relation(fields: [callerId], references: [id], onDelete: Cascade)
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([leadId, callerId])
  @@index([callerId, isActive])
  @@index([businessId])
  @@map("lead_assignments")
}

model Appointment {
  id                 String            @id @default(cuid())
  businessId         String            @map("business_id")
  callerId           String            @map("caller_id")
  leadFirstName      String            @map("lead_first_name")
  leadLastName       String            @map("lead_last_name")
  leadEmail          String?           @map("lead_email")
  leadPhone          String?           @map("lead_phone")
  scheduledAt        DateTime          @map("scheduled_at")
  status             AppointmentStatus @default(PENDING_VERIFICATION)
  verifiedAt         DateTime?         @map("verified_at")
  webhookPayload     Json?             @map("webhook_payload")
  tier               Tier
  businessCharge     Float             @map("business_charge")
  callerPayout       Float             @map("caller_payout")
  platformFee        Float             @default(25) @map("platform_fee")
  notes              String?
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  business           Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  caller             Caller            @relation(fields: [callerId], references: [id], onDelete: Cascade)
  payment            Payment?
  dispute            Dispute?
  rating             Rating?

  @@index([businessId, status])
  @@index([callerId, status])
  @@map("appointments")
}

model Payment {
  id                    String        @id @default(cuid())
  appointmentId         String        @unique @map("appointment_id")
  businessId            String        @map("business_id")
  callerId              String        @map("caller_id")
  amount                Float
  platformFee           Float         @map("platform_fee")
  callerPayout          Float         @map("caller_payout")
  stripePaymentIntentId String?       @map("stripe_payment_intent_id")
  stripeTransferId      String?       @map("stripe_transfer_id")
  status                PaymentStatus @default(PENDING)
  paidAt                DateTime?     @map("paid_at")
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  appointment           Appointment   @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  business              Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  caller                Caller        @relation(fields: [callerId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([callerId])
  @@map("payments")
}

model Rating {
  id              String      @id @default(cuid())
  appointmentId   String      @unique @map("appointment_id")
  businessId      String      @map("business_id")
  callerId        String      @map("caller_id")
  score           Int
  review          String?
  createdAt       DateTime    @default(now()) @map("created_at")

  appointment     Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  business        Business    @relation("BusinessRatings", fields: [businessId], references: [id], onDelete: Cascade)
  caller          Caller      @relation("CallerRatings", fields: [callerId], references: [id], onDelete: Cascade)

  @@map("ratings")
}

model Dispute {
  id              String        @id @default(cuid())
  appointmentId   String        @unique @map("appointment_id")
  businessId      String        @map("business_id")
  reason          String
  description     String
  status          DisputeStatus @default(OPEN)
  resolution      String?
  resolvedAt      DateTime?     @map("resolved_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  appointment     Appointment   @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  business        Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("disputes")
}
