// CloseFlow 2.0 Database Schema
// B2B Appointment Setting Marketplace

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── ENUMS ──────────────────────────────────────────────

enum UserRole {
  BUSINESS
  CALLER
  ADMIN
}

enum Tier {
  BASIC
  ADVANCED
  ELITE
}

enum LeadStatus {
  AVAILABLE
  ASSIGNED
  CONTACTED
  FOLLOW_UP
  NOT_INTERESTED
  CONVERTED
  EXPIRED
}

enum LeadPoolStatus {
  ACTIVE
  PAUSED
  EXPIRED
  FROZEN
}

enum AccessRequestStatus {
  PENDING
  APPROVED
  REJECTED
  REVOKED
}

enum AppointmentStatus {
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
  COMPLETED
  NO_SHOW
  DISPUTED
}

enum DisputeStatus {
  PENDING
  VALID
  INVALID
  RESOLVED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum AccountStatus {
  ACTIVE
  PAUSED
  PAYMENT_ISSUE
  SUSPENDED
  FROZEN
}

enum Industry {
  AI_SERVICES
  SAAS
  WEB_DESIGN
  DIGITAL_MARKETING
  SOFTWARE_DEV
  CONSULTING
  AUTOMATION
  DATA_ANALYTICS
  CYBERSECURITY
  CLOUD_SERVICES
  OTHER
}

// ─── MODELS ─────────────────────────────────────────────

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  passwordHash   String        @map("password_hash")
  name           String
  role           UserRole
  avatarUrl      String?       @map("avatar_url")
  emailVerified  Boolean       @default(false) @map("email_verified")
  isActive       Boolean       @default(true) @map("is_active")
  accountStatus  AccountStatus @default(ACTIVE) @map("account_status")
  lastLoginAt    DateTime?     @map("last_login_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  business       Business?
  caller         Caller?
  notifications  Notification[]
  auditLogs      AuditLog[]

  @@map("users")
}

model Business {
  id                    String         @id @default(cuid())
  userId                String         @unique @map("user_id")
  companyName           String         @map("company_name")
  industry              Industry       @default(OTHER)
  emailDomain           String?        @map("email_domain")
  website               String?
  phone                 String?
  description           String?
  bookingLink           String?        @map("booking_link")
  bookingWebhookUrl     String?        @map("booking_webhook_url")
  verificationWindow    Int            @default(48) @map("verification_window")
  maxCallersPerPool     Int            @default(5) @map("max_callers_per_pool")
  defaultPayoutAmount   Float          @default(75) @map("default_payout_amount")
  stripeAccountId       String?        @map("stripe_account_id")
  stripeCustomerId      String?        @map("stripe_customer_id")
  stripeOnboarded       Boolean        @default(false) @map("stripe_onboarded")
  totalLeadsUploaded    Int            @default(0) @map("total_leads_uploaded")
  totalAppointments     Int            @default(0) @map("total_appointments")
  totalSpent            Float          @default(0) @map("total_spent")
  avgRating             Float          @default(0) @map("avg_rating")
  disputeCount          Int            @default(0) @map("dispute_count")
  falseDisputeCount     Int            @default(0) @map("false_dispute_count")
  paymentFailedAt       DateTime?      @map("payment_failed_at")
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")

  user                  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  leadPools             LeadPool[]
  leads                 Lead[]
  accessRequests        AccessRequest[]
  appointments          Appointment[]
  payments              Payment[]
  ratingsGiven          Rating[]       @relation("BusinessRatings")
  disputesCreated       Dispute[]
  callerNotes           CallerNote[]
  blockedCallers        BlockedCaller[]

  @@map("businesses")
}

model Caller {
  id                    String        @id @default(cuid())
  userId                String        @unique @map("user_id")
  displayName           String        @map("display_name")
  bio                   String?
  location              String?
  timezone              String?
  phone                 String?
  salesExperience       String?       @map("sales_experience")
  proofOfResults        String?       @map("proof_of_results")
  nicheExpertise        Industry[]    @default([]) @map("niche_expertise")
  stripeAccountId       String?       @map("stripe_account_id")
  stripeOnboarded       Boolean       @default(false) @map("stripe_onboarded")
  payoutPreference      String        @default("instant") @map("payout_preference")
  tier                  Tier          @default(BASIC)
  totalLeadsWorked      Int           @default(0) @map("total_leads_worked")
  totalAppointments     Int           @default(0) @map("total_appointments")
  conversionRate        Float         @default(0) @map("conversion_rate")
  avgRating             Float         @default(0) @map("avg_rating")
  totalEarnings         Float         @default(0) @map("total_earnings")
  disputeRate           Float         @default(0) @map("dispute_rate")
  disputeCount          Int           @default(0) @map("dispute_count")
  showUpRate            Float         @default(0) @map("show_up_rate")
  acceptedTerms         Boolean       @default(false) @map("accepted_terms")
  coolingPeriodEnds     DateTime?     @map("cooling_period_ends")
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessRequests        AccessRequest[]
  leadAssignments       LeadAssignment[]
  appointments          Appointment[]
  payments              Payment[]
  ratingsReceived       Rating[]      @relation("CallerRatings")
  achievements          Achievement[]

  @@map("callers")
}

model LeadPool {
  id                String         @id @default(cuid())
  businessId        String         @map("business_id")
  name              String
  industry          Industry       @default(OTHER)
  description       String?
  payoutAmount      Float          @map("payout_amount")
  status            LeadPoolStatus @default(ACTIVE)
  maxCallers        Int            @default(5) @map("max_callers")
  expiresAt         DateTime?      @map("expires_at")
  tags              String[]       @default([])
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  business          Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  leads             Lead[]
  accessRequests    AccessRequest[]

  @@index([businessId, status])
  @@map("lead_pools")
}

model Lead {
  id           String       @id @default(cuid())
  businessId   String       @map("business_id")
  leadPoolId   String?      @map("lead_pool_id")
  name         String
  email        String
  phone        String
  company      String
  industry     String?
  source       String?
  notes        String?
  tags         String[]     @default([])
  status       LeadStatus   @default(AVAILABLE)
  expiresAt    DateTime?    @map("expires_at")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  business     Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  leadPool     LeadPool?    @relation(fields: [leadPoolId], references: [id], onDelete: SetNull)
  assignments  LeadAssignment[]
  appointments Appointment[]

  @@index([businessId, status])
  @@index([leadPoolId])
  @@index([email])
  @@index([phone])
  @@map("leads")
}

model LeadAssignment {
  id           String   @id @default(cuid())
  leadId       String   @map("lead_id")
  callerId     String   @map("caller_id")
  status       LeadStatus @default(ASSIGNED)
  callerNotes  String?  @map("caller_notes")
  assignedAt   DateTime @default(now()) @map("assigned_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  lead         Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  caller       Caller   @relation(fields: [callerId], references: [id], onDelete: Cascade)

  @@unique([leadId, callerId])
  @@index([callerId])
  @@map("lead_assignments")
}

model AccessRequest {
  id           String              @id @default(cuid())
  leadPoolId   String              @map("lead_pool_id")
  callerId     String              @map("caller_id")
  businessId   String              @map("business_id")
  message      String?
  status       AccessRequestStatus @default(PENDING)
  respondedAt  DateTime?           @map("responded_at")
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")

  leadPool     LeadPool            @relation(fields: [leadPoolId], references: [id], onDelete: Cascade)
  caller       Caller              @relation(fields: [callerId], references: [id], onDelete: Cascade)
  business     Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([leadPoolId, callerId])
  @@index([businessId, status])
  @@index([callerId, status])
  @@map("access_requests")
}

model Appointment {
  id                 String            @id @default(cuid())
  leadId             String            @map("lead_id")
  businessId         String            @map("business_id")
  callerId           String            @map("caller_id")
  bookingId          String?           @map("booking_id")
  scheduledAt        DateTime          @map("scheduled_at")
  status             AppointmentStatus @default(PENDING_VERIFICATION)
  verifiedAt         DateTime?         @map("verified_at")
  webhookPayload     Json?             @map("webhook_payload")
  callerTier         Tier              @map("caller_tier")
  payoutAmount       Float             @map("payout_amount")
  platformFee        Float             @default(25) @map("platform_fee")
  totalCharge        Float             @map("total_charge")
  notes              String?
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  lead               Lead              @relation(fields: [leadId], references: [id], onDelete: Cascade)
  business           Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  caller             Caller            @relation(fields: [callerId], references: [id], onDelete: Cascade)
  payment            Payment?
  dispute            Dispute?
  rating             Rating?

  @@index([businessId, status])
  @@index([callerId, status])
  @@index([leadId])
  @@map("appointments")
}

model Payment {
  id                    String        @id @default(cuid())
  appointmentId         String        @unique @map("appointment_id")
  businessId            String        @map("business_id")
  callerId              String        @map("caller_id")
  totalAmount           Float         @map("total_amount")
  platformFee           Float         @map("platform_fee")
  callerPayout          Float         @map("caller_payout")
  stripePaymentIntentId String?       @map("stripe_payment_intent_id")
  stripeTransferId      String?       @map("stripe_transfer_id")
  status                PaymentStatus @default(PENDING)
  failedAt              DateTime?     @map("failed_at")
  paidAt                DateTime?     @map("paid_at")
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  appointment           Appointment   @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  business              Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  caller                Caller        @relation(fields: [callerId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([callerId])
  @@index([status])
  @@map("payments")
}

model Rating {
  id              String      @id @default(cuid())
  appointmentId   String      @unique @map("appointment_id")
  businessId      String      @map("business_id")
  callerId        String      @map("caller_id")
  score           Int
  review          String?
  createdAt       DateTime    @default(now()) @map("created_at")

  appointment     Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  business        Business    @relation("BusinessRatings", fields: [businessId], references: [id], onDelete: Cascade)
  caller          Caller      @relation("CallerRatings", fields: [callerId], references: [id], onDelete: Cascade)

  @@map("ratings")
}

model Dispute {
  id              String        @id @default(cuid())
  appointmentId   String        @unique @map("appointment_id")
  businessId      String        @map("business_id")
  callerId        String        @map("caller_id")
  reason          String
  description     String
  evidence        String?
  status          DisputeStatus @default(PENDING)
  resolution      String?
  resolvedAt      DateTime?     @map("resolved_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  appointment     Appointment   @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  business        Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("disputes")
}

model CallerNote {
  id           String   @id @default(cuid())
  businessId   String   @map("business_id")
  callerId     String   @map("caller_id")
  note         String
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, callerId])
  @@map("caller_notes")
}

model BlockedCaller {
  id           String   @id @default(cuid())
  businessId   String   @map("business_id")
  callerId     String   @map("caller_id")
  reason       String?
  createdAt    DateTime @default(now()) @map("created_at")

  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, callerId])
  @@map("blocked_callers")
}

model Achievement {
  id           String   @id @default(cuid())
  callerId     String   @map("caller_id")
  type         String
  label        String
  description  String?
  unlockedAt   DateTime @default(now()) @map("unlocked_at")

  caller       Caller   @relation(fields: [callerId], references: [id], onDelete: Cascade)

  @@index([callerId])
  @@map("achievements")
}

model Notification {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  type         String
  title        String
  message      String
  data         Json?
  read         Boolean  @default(false)
  createdAt    DateTime @default(now()) @map("created_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  action       String
  resource     String
  resourceId   String?  @map("resource_id")
  details      Json?
  ipAddress    String?  @map("ip_address")
  createdAt    DateTime @default(now()) @map("created_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

model FraudAlert {
  id           String   @id @default(cuid())
  type         String
  severity     String   @default("medium")
  description  String
  businessId   String?  @map("business_id")
  callerId     String?  @map("caller_id")
  data         Json?
  resolved     Boolean  @default(false)
  resolvedAt   DateTime? @map("resolved_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([resolved])
  @@index([severity])
  @@map("fraud_alerts")
}
